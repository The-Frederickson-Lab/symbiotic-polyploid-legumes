---
title: "PGLS analysis"
author: "Tia Harrison"
date: "`r format(Sys.Date())`"
output: github_document 
editor_options: 
  chunk_output_type: console
---

## Overall setup

### Global setup, load relevant packages 

```{r setup, include=FALSE}

# Global setup
knitr::opts_chunk$set(echo = TRUE)

# Packages 
library(tidyverse)
library(car)
library(lsmeans)
library(lme4)
library(MASS)
library(ape)
library(inauguration)
library(ggpubr)
library(plotrix)
library(nlme)
library(geiger)
library(lmtest)
library(sandwich)
library(performance)
library(phytools)

```

### Dataset 

## Ploidy dataset and phylogeny 

The spreadsheet contains information about the symbiotic status (Fixer column) of each legume species where 1 indicates a legume that forms nodules with rhizobia (symbiotic) and where 0 indicates a plant that forms no association with rhizobia (nonsymbiotic). The diPloidyLow column indicates whether plant species are diploids (coded as 0) or polyploid (coded as 1). The diPloidyLow values were calculated from genus-level data. The Num_Introduced column indicates how many separate ranges a plant species has been introduced to as calculated in Simonsen et al (2017). 

The phylogeny used in this analysis is a version of the Zanne et al (2014) angiosperm phylogeny where the full phylogeny was pruned for the species in our dataset. 


```{r}
# Dataset 
ploidy<- read.csv("Legume_ploidy_dataset.csv", row.names=1)

# Phylogeny 
legumes1<-read.tree("Vascular_Plants_rooted.dated.tre")

```


### Clean up the dataset

Here, we create a new column called "NewPloidy" which indicates diploidy (0) and polyploidy (1) but was calculated from a combination of genus and subfamily level data. 

We also added symbiotic species to our Fixer column if we had data from Harrison et al. (2018) that suggested those species associated with a rhizobium genus or OTU. 

```{r}

# If diPloidyLow (genus-level ploidy) is available use it and if not then use disfPloidy_corrected (subfamily with some species double checked in the literature)
# If there is data for NumGenera or OTUs then call the associating legume species a fixer 
ploidy1<-ploidy%>% 
  rownames_to_column() %>%
  mutate(NewPloidy = ifelse(is.na(diPloidyLow), disfPloidy_corrected, diPloidyLow)) %>% 
  mutate(Fixer = ifelse(is.na(Fixer) & numOTUs >= 1, 1, Fixer)) %>%
  mutate(Fixer = ifelse(is.na(Fixer) & numGenera >=1 , 1, Fixer)) %>%
  column_to_rownames()

```


### Prune the dataset and tree 

```{r}
# Make sure the data and tree match up 
TreeOnly <- setdiff(legumes1$tip.label, rownames(ploidy1))
DataOnly <- setdiff(rownames(ploidy1), legumes1$tip.label)

# Prune the tree 
pruned <- drop.tip(legumes1, TreeOnly)
pruned$node.label <- NULL

# Get the tip names 
tip_names<-data.frame(pruned$tip.label)

# Filter the dataset for tree species 
ploidy_data<-ploidy1 %>%
  filter(rownames(ploidy1) %in% tip_names$pruned.tip.label) 

# Set columns as factors for analysis 
# Set Species as its own column
ploidy_data1 <- ploidy_data %>%
  rownames_to_column("Species") %>%
  mutate(Fixer=as.factor(Fixer), 
         numGenera=as.factor(numGenera), 
         Specialist=as.factor(Specialist), 
         diPloidyLow=as.factor(diPloidyLow), 
         NewPloidy=as.factor(NewPloidy))
```

### Data exploration 

How many species in each data type? 

```{r}
# Data summary for genus level ploidy 
ploidy_data1 %>%
  filter(!is.na(diPloidyLow) & !is.na(Num_Introduced) & !is.na(Fixer)) %>%
  group_by(diPloidyLow, Fixer) %>%
  tally()

# Average of introduced ranges 
ploidy_data1 %>%
  filter(!is.na(diPloidyLow) & !is.na(Num_Introduced) & !is.na(Fixer)) %>%
  group_by(diPloidyLow, Fixer) %>%
  summarize(mean(Num_Introduced))

# What are the two non-symbiotic polyploid species? 
ploidy_data1 %>% 
  filter(diPloidyLow==1 & Fixer ==0)
# Cassia fistula 7 human uses 
# Cassia grandis 4 human uses 

# Average number of human uses 
ploidy_data1 %>%
  filter(!is.na(Fixer) & !is.na(Human_Uses)) %>%
  group_by(Fixer) %>%
  summarize(mean(Human_Uses))

# Data summary for subfamily level ploidy data (ploidy corrected)
ploidy_data1 %>%
  filter(!is.na(NewPloidy) & !is.na(Num_Introduced) & !is.na(Fixer)) %>%
  group_by(NewPloidy, Fixer) %>%
  tally()

# Average number of human uses in specialists
ploidy_data1 %>%
  filter(!is.na(Specialist) & !is.na(Human_Uses) & !is.na(NewPloidy)) %>%
  group_by(Specialist, NewPloidy) %>%
  summarize(mean(Human_Uses))

```

## Comparison of genus level and genus+subfamily data 
Here we looked at the species added in the genus+subfamily dataset in terms of fixer status and number of introduced ranges. 

```{r}
add_spp<- ploidy_data1 %>%
  filter(!is.na(NewPloidy) & is.na(diPloidyLow) & !is.na(Num_Introduced) & !is.na(Fixer))

add_spp %>% 
  group_by(Fixer, NewPloidy) %>% 
  tally()

add_spp %>% 
  group_by(Fixer, NewPloidy) %>%
  summarize(mean(Num_Introduced))

# Average number of ranges in the species that are based on subfamily values 
add_spp %>%
  filter(is.na(diPloidyLow) & !is.na(disfPloidy_corrected)) %>%
  summarize(mean(Num_Introduced)) # 4.2742 

# Average number of ranges in the species that are based on genus values 
ploidy_data1 %>%
  filter(!is.na(NewPloidy) & !is.na(diPloidyLow) & !is.na(Fixer) & !is.na(Num_Introduced)) %>%
  summarize(mean(Num_Introduced)) # 5.262048

  
```


## Data analysis 

### Correlation tests 

We looked at the correlation between subfamily base chromosome number and genus base chromosome number to determine how similar our two datasets are. 

```{r}
# Spearman's rank correlation 
# Ties present so we didn't compute exact p value 
cor.test(ploidy_data1$PloidyLow, ploidy_data1$sfPloidy, method="spearman", exact=FALSE)

# Kendall tau correlation to deal with ties 
cor.test(ploidy_data1$PloidyLow, ploidy_data1$sfPloidy, method="kendall")

```


### PGLS on the genus + subfamily level ploidy data  
We performed our anlayses on the genus + subfamily dataset since it had the most data points in each category of data (diploid non-symbiotic, diploid symbiotic, polyploid non-symbiotic, and polyploid symbiotic). We tested the hypothesis that ploidy and symbiotic status or rhizobia specificity interact to impact range expansion using pgls models with the nlme package. 

In the PGLS model if you are having trouble getting the model to converge try setting different values for lambda (0, 1, or 0.5). 
If changing lambda doesn't work try this code to get convergence in the model: 
control=glsControl(opt="optim",optimMethod="Nelder-Mead") 

#### Symbiosis and ploidy models 

```{r}
# Run phylosig on the whole dataset 
# Values need to match tree species so prep the data and filter
ploidy_data_whole <- ploidy_data1 %>%
  column_to_rownames("Species")
introductions_whole<-ploidy_data_whole$Num_Introduced
names(introductions_whole)<- rownames(ploidy_data_whole)
phylosig(pruned, introductions_whole, method="lambda", test=TRUE) #  0.194648 and significant 

# Estimate lambda and its significance to see if it is worth using pgls or a glm model instead 
# Just estimate lambda in data for test 
ploidy_data_match <- ploidy_data1 %>%
  column_to_rownames("Species") %>%
  filter(!is.na(NewPloidy) & !is.na(Fixer))
introductions<-ploidy_data_match$Num_Introduced
names(introductions)<- rownames(ploidy_data_match)

# Run phylosig to estimate lambda 
phylosig(pruned, introductions, method="lambda", test=TRUE) # 0.194005 and significant 

# Run pgls and allow lambda to vary in symbiotic status
model_sub2<-gls(log10(Num_Introduced+1) ~ NewPloidy*Fixer + AbsLatNative + areaNativeScale + Human_Uses + annual, data=ploidy_data1, correlation=corPagel(value=0, phy=pruned, fixed=FALSE, form=~"Species"), method = "ML", na.action=na.exclude)

# Inspect model fit 
plot(model_sub2)
plot(fitted(model_sub2), sqrt(abs(resid(model_sub2))), main="Scale-location")
hist(resid(model_sub2))
qqnorm(resid(model_sub2))
qqline(resid(model_sub2))

# Test for significance 
summary(model_sub2)
Anova(model_sub2, contrasts=list(topic=contr.sum, sys=contr.sum), type=3) # Type 3 for interaction and contrasts set 
# Ploidy estimates have the expected sign, interaction is non-significant, but fixer estimate is opposite to what is expected 

# Get means from the model 
model_sub2_results<-lsmeans(model_sub2, pairwise~NewPloidy+Fixer, mode = "df.error")
model_sub2_results<-data.frame(model_sub2_results$lsmeans)

#Lambda is very close to zero, so perhaps not strong phylogenetic clustering of trait
#Therefore compare to a phylogenetically uncorrected model

#Let's start with a Poisson model
model_poisson <- glm(Num_Introduced ~ NewPloidy*Fixer + AbsLatNative + areaNativeScale + Human_Uses + annual, data=ploidy_data1, family="poisson")

#Inspect model fit
plot(model_poisson) #Fit isn't awesome
check_overdispersion(model_poisson) # Overdispersion detected 

summary(model_poisson) #Probably not correct because of over-dispersion
coeftest(model_poisson, vcov = sandwich) #Recompute Wald tests using sandwich standard errors, and it's likely more correct
Anova(model_poisson, contrasts=list(topic=contr.sum, sys=contr.sum), type=3)


# Try including random term for species to help with overdispersion problem 
ploidy_data2 <- ploidy_data1 %>%
  mutate(Species = as.factor(Species))

model_poisson_rand <- glmer(Num_Introduced ~ NewPloidy*Fixer + AbsLatNative + areaNativeScale + Human_Uses + annual + (1|Species), data=ploidy_data2, family="poisson")

#Inspect model fit
plot(model_poisson_rand) 
plot(fitted(model_poisson_rand), sqrt(abs(resid(model_poisson_rand))), main="Scale-location")
qqnorm(resid(model_poisson_rand))
qqline(resid(model_poisson_rand)) # Fit got worse
check_overdispersion(model_poisson_rand)  

summary(model_poisson_rand) #Probably not correct because of over-dispersion
Anova(model_poisson_rand, contrasts=list(topic=contr.sum, sys=contr.sum), type=3)


#Quasipoisson model for number of introductions is probably preferable given over-dispersion
model_qpoisson <-glm(Num_Introduced ~ NewPloidy*Fixer + AbsLatNative + areaNativeScale + Human_Uses + annual, data=ploidy_data1, family="quasipoisson")

#Inspect model fit
plot(model_qpoisson) #Fit isn't awesome but maybe the best so far 

# Check summary output 
summary(model_qpoisson)
coeftest(model_qpoisson, vcov = sandwich) 
Anova(model_qpoisson, contrasts=list(topic=contr.sum, sys=contr.sum), type=3)


```


#### Specificity and ploidy models 

```{r}
# Estimate lambda and its significance to see if it is worth using pgls or a glm model instead 
# Values need to match tree species so prep the data and filter
ploidy_data_match2 <- ploidy_data1 %>%
  column_to_rownames("Species") %>%
  filter(!is.na(NewPloidy) & !is.na(Specialist))
introductions2<-ploidy_data_match2$Num_Introduced
names(introductions2)<- rownames(ploidy_data_match2)

# Run phylosig to estimate lambda 
phylosig(pruned, introductions2, method="lambda", test=TRUE) # 0.346448 and significant 


# Run pgls for specificity on rhizobia 
model_sub_spec2<-gls(log10(Num_Introduced+1) ~ NewPloidy*Specialist + AbsLatNative + areaNativeScale + Human_Uses + annual, data=ploidy_data1, correlation=corPagel(value=0, phy=pruned, fixed=FALSE, form=~"Species"), method = "ML", na.action=na.exclude, control=glsControl(opt="optim",optimMethod="Nelder-Mead"))

# Inspect model fit 
plot(model_sub_spec2)
plot(fitted(model_sub_spec2), sqrt(abs(resid(model_sub_spec2))), main="Scale-location")
qqnorm(resid(model_sub_spec2))
qqline(resid(model_sub_spec2))

# Test for significance 
summary(model_sub_spec2)
Anova(model_sub_spec2, contrasts=list(topic=contr.sum), type=3)
# Ploidy estimate sign is correct, specialist estimate is opposite sign as to what expected, interaction is significant 

# Grab the model means 
model_sub_spec2_results<-lsmeans(model_sub_spec2, pairwise~NewPloidy+Specialist, mode = "df.error")
model_sub_spec2_results<-data.frame(model_sub_spec2_results$lsmeans)

# Lambda estimated in the model is negative so likely overdispersed 
# Phylogenetically uncorrected model is probably better and more appropriate 

#Fit Poisson model for specificity 
model_spec_poisson <- glm(Num_Introduced ~ NewPloidy*Specialist + AbsLatNative + areaNativeScale + Human_Uses + annual, data=ploidy_data1, family="poisson")

#Inspect model fit
plot(model_spec_poisson) #Fit isn't terrible
check_overdispersion(model_spec_poisson)

summary(model_spec_poisson) 
coeftest(model_spec_poisson, vcov = sandwich) #Recompute Wald tests using sandwich standard errors, and it's likely more correct

# Try including random term for species to help with overdispersion problem 
model_spec_poisson_rand <- glmer(Num_Introduced ~ NewPloidy*Specialist + AbsLatNative + areaNativeScale + Human_Uses + annual + (1|Species), data=ploidy_data2, family="poisson")

# Inspect model fit
plot(model_spec_poisson_rand) 
plot(fitted(model_spec_poisson_rand), sqrt(abs(resid(model_spec_poisson_rand))), main="Scale-location")
qqnorm(resid(model_spec_poisson_rand))
qqline(resid(model_spec_poisson_rand)) # Fit is bad


#Quasipoisson model for number of introductions is probably preferable given over-dispersion
model_spec_qpoisson <-glm(Num_Introduced ~ NewPloidy*Specialist + AbsLatNative + areaNativeScale + Human_Uses + annual, data=ploidy_data1, family="quasipoisson")

#Inspect model fit
plot(model_spec_qpoisson) # Pretty good

# Summary output 
summary(model_spec_qpoisson)
coeftest(model_spec_qpoisson, vcov = sandwich) 
Anova(model_spec_qpoisson, contrasts=list(topic=contr.sum, sys=contr.sum), type=3)
```


### Analyzing the non-symbiotic and symbiotic species separately

Here we subset the data to only the non-symbiotic species in the combined genus+subfamily dataset to look for an effect of ploidy on invasion. 

```{r}
# Subset the data to non-symbiotic species 
ploidy_data_non <- ploidy_data1 %>%
  filter(Fixer == 0)
# Reduces the dataset to 68 species and two categories (diploid and polyploid)

# Run pgls and allow lambda to vary
model_sub_non<-gls(log10(Num_Introduced + 1) ~ NewPloidy + AbsLatNative + areaNativeScale + Human_Uses + annual, data=ploidy_data_non, correlation=corPagel(value=0, phy=pruned, fixed=FALSE, form=~"Species"), method = "ML", na.action=na.exclude)

# Inspect model fit 
plot(model_sub_non)
qqnorm(resid(model_sub_non))
qqline(resid(model_sub_non)) # This looks pretty ok with the raw data but maybe a bit better with the logged values 

# Test for significance 
summary(model_sub_non)
Anova(model_sub_non, type=2,  contrasts=list(topic=contr.sum)) # Type 2 anova 
# Significant effect of ploidy

# Subset the data to symbiotic species 
ploidy_data_sym <- ploidy_data1 %>%
  filter(Fixer == 1)

# Run pgls and allow lambda to vary 
model_sub_sym<-gls(log10(Num_Introduced + 1) ~ NewPloidy + AbsLatNative + areaNativeScale + Human_Uses + annual, data=ploidy_data_sym, correlation=corPagel(value=0, phy=pruned, fixed=FALSE, form=~"Species"), method = "ML", na.action=na.exclude)

# Inspect model fit 
plot(model_sub_sym)
qqnorm(resid(model_sub_sym))
qqline(resid(model_sub_sym))

# Test for significance 
summary(model_sub_sym)
Anova(model_sub_sym, type=2,  contrasts=list(topic=contr.sum))
# No significant effect of ploidy here 

# Lambda very close to zero so could go for a uncorrected model 

# Poisson 
model_sub_sym_poisson<-glm(Num_Introduced ~ NewPloidy + AbsLatNative + areaNativeScale + Human_Uses + annual, data=ploidy_data_sym, family="poisson")

# Check fit 
plot(model_sub_sym_poisson) # Not great 
check_overdispersion(model_sub_sym_poisson) # some overdispersion 

# Include random term to help with overdispersion
model_sub_sym_rand<-glmer(Num_Introduced ~ NewPloidy + AbsLatNative + areaNativeScale + Human_Uses + annual + (1|Species), data=ploidy_data_sym, family="poisson")

# Check fit 
plot(model_sub_sym_rand) 
plot(fitted(model_sub_sym_rand), sqrt(abs(resid(model_sub_sym_rand))), main="Scale-location")
qqnorm(resid(model_sub_sym_rand))
qqline(resid(model_sub_sym_rand)) # Worse fit 
check_overdispersion(model_sub_sym_rand) # No overdispersion 

# Quassipoisson 
model_sub_sym_qpoisson<-glm(Num_Introduced ~ NewPloidy + AbsLatNative + areaNativeScale + Human_Uses + annual, data=ploidy_data_sym, family="quasipoisson")

# Check fit 
plot(model_sub_sym_qpoisson) # Not the greatest fit but maybe best of the bunch 

# Summary output 
summary(model_sub_sym_qpoisson)
coeftest(model_sub_sym_qpoisson, vcov = sandwich) 
Anova(model_sub_sym_qpoisson, contrasts=list(topic=contr.sum, sys=contr.sum), type=2)

# Both phylogenetic models and phylogenetic model shows that when it is symbiotic, ploidy does not have an impact on range 

```


## Plotting the results 

### Raw genus+subfamily level data 

Here we plot the means and standard error calculated from the raw data in the expanded dataset (more data points in each category). 

```{r}
# Prep the data for plotting 
ploidy_sub_sum<- ploidy_data1 %>%
  filter(!is.na(Fixer) & !is.na(NewPloidy)) %>%
  dplyr::group_by(NewPloidy, Fixer) %>%
  dplyr::summarise(mean=mean(Num_Introduced), se=std.error(Num_Introduced))

# Get colours 
ploidy_colours<-inauguration("inauguration_2021")

# Reaction norm plot 
sub_interaction<-ggplot(ploidy_sub_sum, aes(x=Fixer, y=mean, fill=NewPloidy)) + 
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0.1, position=position_dodge(0.2)) +
  geom_line(aes(group=NewPloidy), position=position_dodge(0.2)) +
  geom_point(pch =21, size=4, position=position_dodge(0.2)) + 
  (ylab("Introduced ranges (no.)")) +
  (xlab("Symbiotic state")) +
  scale_fill_manual(name="", labels=c("Diploid", "Polyploid"), values=ploidy_colours[c(6,4)]) +
  scale_x_discrete(labels=c("1" = "Symbiotic", "0" = "Non-symbiotic"), limits=c("1", "0")) + 
  theme_classic() +
  theme(axis.title.x = element_text(size=13), 
        axis.title.y = element_text(size=13), 
        axis.text.y= element_text(size=12), 
        axis.text.x= element_text(size=12),
        legend.title= element_text(size=12), 
        legend.text=element_text(size=12), 
        legend.position="top")

# Prep data for specificity on rhizobia 
ploidy_sub_spec<- ploidy_data1 %>%
  filter(!is.na(Specialist) & !is.na(NewPloidy)) %>%
  dplyr::group_by(NewPloidy, Specialist) %>%
  dplyr::summarise(mean=mean(Num_Introduced), se=std.error(Num_Introduced))

# Reaction norm for specificity 
sub_spec<-ggplot(ploidy_sub_spec, aes(x=Specialist, y=mean, fill=NewPloidy)) + 
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0.1, position=position_dodge(0.2)) +
  geom_line(aes(group=NewPloidy), position=position_dodge(0.2)) +
  geom_point(pch =21, size=4, position=position_dodge(0.2)) + 
  (ylab("Introduced ranges (no.)")) +
  (xlab("Specificity on rhizobia")) +
  scale_fill_manual(name="", labels=c("Diploid", "Polyploid"), values=ploidy_colours[c(6,4)]) +
  scale_x_discrete(labels=c("1" = "Specialist", "0" = "Generalist"), limits=c("1", "0")) + 
  theme_classic() +
  theme(axis.title.x = element_text(size=13), 
        axis.title.y = element_text(size=13), 
        axis.text.y= element_text(size=12), 
        axis.text.x= element_text(size=12),
        legend.title= element_text(size=12), 
        legend.text=element_text(size=12), 
        legend.position="top")

# Combine the two plots 
Figure_raw <- ggarrange(sub_interaction, sub_spec,
                    labels=c("a", "b"), 
                    ncol = 2, nrow=1,
                    common.legend=TRUE, 
                    legend = "top")
Figure_raw
```

### PGLS interaction of ploidy and symbiosis 

The means and standard deviation plotted here are output from the pgls models in our analyses. 

```{r}

# Prep the output from the model  
model_sub2_results <- model_sub2_results %>%
  mutate(NewPloidy=as.factor(NewPloidy)) %>%
  mutate(Fixer=as.factor(Fixer))
model_sub2_results

# Plot the means 
sub_interaction2<-ggplot(model_sub2_results, aes(x=Fixer, y=lsmean, fill=NewPloidy)) + 
  geom_errorbar(aes(ymin=lsmean-SE, ymax=lsmean+SE), width=0.1, position=position_dodge(0.2)) +
  geom_line(aes(group=NewPloidy), position=position_dodge(0.2)) +
  geom_point(pch =21, size=4, position=position_dodge(0.2)) + 
  (ylab("Introduced ranges (log)")) +
  (xlab("Symbiotic state")) +
  scale_fill_manual(name="", labels=c("Diploid", "Polyploid"), values=ploidy_colours[c(6,4)]) +
  scale_x_discrete(labels=c("1" = "Symbiotic", "0" = "Non-symbiotic"), limits=c("1", "0")) + 
  theme_classic() +
  theme(axis.title.x = element_text(size=13), 
        axis.title.y = element_text(size=13), 
        axis.text.y= element_text(size=12), 
        axis.text.x= element_text(size=12),
        legend.title= element_text(size=12), 
        legend.text=element_text(size=12), 
        legend.position="top")

# Prep the output from the model  
model_sub_spec2_results <- model_sub_spec2_results %>%
  mutate(NewPloidy=as.factor(NewPloidy)) %>%
  mutate(Specialist=as.factor(Specialist))

# Plot the model means 
sub_spec2<-ggplot(model_sub_spec2_results, aes(x=Specialist, y=lsmean, fill=NewPloidy)) + 
  geom_errorbar(aes(ymin=lsmean-SE, ymax=lsmean+SE), width=0.1, position=position_dodge(0.2)) +
  geom_line(aes(group=NewPloidy), position=position_dodge(0.2)) +
  geom_point(pch =21, size=4, position=position_dodge(0.2)) + 
  (ylab("Introduced ranges (log)")) +
  (xlab("Specificity on rhizobia")) +
  scale_fill_manual(name="", labels=c("Diploid", "Polyploid"), values=ploidy_colours[c(6,4)]) +
  scale_x_discrete(labels=c("1" = "Specialist", "0" = "Generalist"), limits=c("1", "0")) + 
  theme_classic() +
  theme(axis.title.x = element_text(size=13), 
        axis.title.y = element_text(size=13), 
        axis.text.y= element_text(size=12), 
        axis.text.x= element_text(size=12),
        legend.title= element_text(size=12), 
        legend.text=element_text(size=12), 
        legend.position="top")

# Combine the plots 
Figure_pgls <- ggarrange(sub_interaction2, sub_spec2,
                    labels=c("a", "b"), 
                    ncol = 2, nrow=1,
                    common.legend=TRUE, 
                    legend = "top")
Figure_pgls

```

### Quasi-poisson interaction of ploidy and symbiosis 

Results from the glm models where data was fit to a quasi-poisson distribution 

```{r}
# Prep the output from the model  
# Get means from the model 
model_q_results<-lsmeans(model_qpoisson, pairwise~NewPloidy+Fixer, mode = "df.error")
model_q_results<-data.frame(model_q_results$lsmeans)

model_q_results2 <- model_q_results %>%
  mutate(NewPloidy=as.factor(NewPloidy)) %>%
  mutate(Fixer=as.factor(Fixer))


# Plot the means 
q_interaction<-ggplot(model_q_results2, aes(x=Fixer, y=lsmean, fill=NewPloidy)) + 
  geom_errorbar(aes(ymin=lsmean-SE, ymax=lsmean+SE), width=0.1, position=position_dodge(0.2)) +
  geom_line(aes(group=NewPloidy), position=position_dodge(0.2)) +
  geom_point(pch =21, size=4, position=position_dodge(0.2)) + 
  (ylab("GLM means (introduced ranges)")) +
  (xlab("Symbiotic state")) +
  scale_fill_manual(name="", labels=c("Diploid", "Polyploid"), values=ploidy_colours[c(6,4)]) +
  scale_x_discrete(labels=c("1" = "Symbiotic", "0" = "Non-symbiotic"), limits=c("1", "0")) + 
  theme_classic() +
  theme(axis.title.x = element_text(size=13), 
        axis.title.y = element_text(size=13), 
        axis.text.y= element_text(size=12), 
        axis.text.x= element_text(size=12),
        legend.title= element_text(size=12), 
        legend.text=element_text(size=12), 
        legend.position="top")

# Prep the output from the model  
model_q_spec_results<-lsmeans(model_spec_qpoisson, pairwise~NewPloidy+Specialist, mode = "df.error")
model_q_spec_results<-data.frame(model_q_spec_results$lsmeans)

model_q_spec_results2 <- model_q_spec_results %>%
  mutate(NewPloidy=as.factor(NewPloidy)) %>%
  mutate(Specialist=as.factor(Specialist))

# Plot the model means 
q_spec_interaction<-ggplot(model_q_spec_results2, aes(x=Specialist, y=lsmean, fill=NewPloidy)) + 
  geom_errorbar(aes(ymin=lsmean-SE, ymax=lsmean+SE), width=0.1, position=position_dodge(0.2)) +
  geom_line(aes(group=NewPloidy), position=position_dodge(0.2)) +
  geom_point(pch =21, size=4, position=position_dodge(0.2)) + 
  (ylab("GLM means (introduced ranges)")) +
  (xlab("Specificity on rhizobia")) +
  scale_fill_manual(name="", labels=c("Diploid", "Polyploid"), values=ploidy_colours[c(6,4)]) +
  scale_x_discrete(labels=c("1" = "Specialist", "0" = "Generalist"), limits=c("1", "0")) + 
  theme_classic() +
  theme(axis.title.x = element_text(size=13), 
        axis.title.y = element_text(size=13), 
        axis.text.y= element_text(size=12), 
        axis.text.x= element_text(size=12),
        legend.title= element_text(size=12), 
        legend.text=element_text(size=12), 
        legend.position="top")

# Combine the plots 
Figure_qpoisson <- ggarrange(q_interaction, q_spec_interaction,
                    labels=c("a", "b"), 
                    ncol = 2, nrow=1,
                    common.legend=TRUE, 
                    legend = "top")
Figure_qpoisson

```

